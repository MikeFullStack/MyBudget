rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    
    // 1. User Data & Budgets (Owned)
    match /artifacts/mon-budget/users/{userId} {
      allow read, write: if request.auth != null && request.auth.uid == userId;

      match /budgets/{budgetId} {
        // Owner full access
        allow read, write: if request.auth != null && request.auth.uid == userId;
        
        // Transactions Subcollection (Owner)
        match /transactions/{txId} {
          allow read, write: if request.auth != null && request.auth.uid == userId;
        }
      }
    }

    // 2. Shared Access (Collection Group)
    match /{path=**}/budgets/{budgetId} {
      // Helper to check permissions
      function isParticipant(rsc) {
        let hasEmail = 'participants' in rsc.data && rsc.data.participants.hasAny([request.auth.token.email]);
        let hasUid = 'participantIds' in rsc.data && rsc.data.participantIds.hasAny([request.auth.uid]);
        return hasEmail || hasUid;
      }

      allow read: if request.auth != null && isParticipant(resource);
      allow update: if request.auth != null && isParticipant(resource);
      
      // Allow 'claim' (adding self to participantIds) if we are in email list
      // This is covered by 'allow update' above if we are in email list.

      // Subcollection access for shared budgets
      match /transactions/{txId} {
        allow read, write: if request.auth != null && 
                           isParticipant(get(/databases/$(database)/documents/$(path)/budgets/$(budgetId)));
      }
    }
  }
}
